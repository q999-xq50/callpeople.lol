<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Group Call App â€” Dynamic & Organized</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f0f11;
      --panel:#121214;
      --muted:#9aa0a6;
      --accent:#0b84ff;
      --danger:#ff4d4f;
      --success:#1dd1a1;
      --card:#161618;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0b0c,#121214 60%);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;color:#e6eef8}
    .wrap{max-width:1200px;margin:16px auto;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{font-size:20px;margin:0;color:white}
    .sub{font-size:13px;color:var(--muted)}
    /* panels */
    #loginPanel, #callPanel{background:linear-gradient(180deg,var(--card),#0f0f10);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.45);transition:transform .22s ease,opacity .22s ease}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=text]{padding:8px 10px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:#fff;min-width:160px}
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid #26313b;color:var(--muted);font-weight:600}
    button.danger{background:var(--danger)}
    small.note{color:var(--muted);display:block;margin-top:8px}
    /* layout */
    #callBody{display:flex;gap:14px;margin-top:12px}
    #leftCol{flex:1;min-width:280px}
    #rightCol{width:360px}
    /* video grid */
    #videos{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
      align-items:start;
      transition:all .2s ease;
    }
    .vidCard{position:relative;border-radius:10px;overflow:hidden;background:#000;height:0;padding-bottom:56.25%;display:flex;align-items:center;justify-content:center;transform-origin:center;transition:transform .18s ease,box-shadow .18s ease}
    .vidCard:hover{transform:translateY(-6px)}
    .vidCard video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:black}
    .label{
      position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);padding:6px 8px;border-radius:8px;color:#fff;font-size:13px;display:flex;gap:8px;align-items:center
    }
    .micMute{color:var(--danger);font-weight:700}
    .hostBadge{background:linear-gradient(90deg,#ffecb3,#ffd29b);color:#2b2b2b;padding:2px 6px;border-radius:6px;font-weight:700;font-size:12px}
    /* camera off overlay */
    .cameraOffOverlay{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.75));color:#dfe7ff;font-size:14px;font-weight:700;
      z-index:3;text-align:center;padding:12px;pointer-events:none
    }
    /* toolbar */
    #toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;align-items:center}
    .tool{background:#0f1720;color:#cfe6ff;padding:8px 10px;border-radius:8px;border:1px solid #1f2a33;cursor:pointer}
    #roomDisplay{font-weight:700;color:#cfe6ff;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    /* right column - panels */
    .panel{background:#0b0b0b;padding:12px;border-radius:10px;margin-bottom:10px}
    .participants{display:flex;flex-direction:column;gap:8px}
    .participantRow{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#0d0d10,#0a0a0b);transition:background .15s}
    .participantRow:hover{background:#111214}
    .participantRow button{padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
    /* chat */
    #chatBox{display:flex;flex-direction:column;height:300px;gap:8px;transition:transform .22s ease,opacity .22s}
    #messages{flex:1;overflow:auto;padding:8px;background:#070809;border-radius:8px}
    .msg{margin-bottom:6px;font-size:13px}
    .msg .time{font-size:11px;color:var(--muted);margin-left:8px}
    .msg.me{color:var(--success);font-weight:600}
    .msg.other{color:#d8e7ff}
    form.chatForm{display:flex;gap:8px}
    form.chatForm input{flex:1;padding:8px;border-radius:8px;border:1px solid #222;background:#0b0b0b;color:#fff}
    /* unread badge */
    .badge{display:inline-block;background:#0b3d91;color:white;padding:4px 7px;border-radius:12px;font-size:12px}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .18s}
    .modal{background:var(--panel);padding:18px;border-radius:10px;min-width:300px;box-shadow:0 10px 40px rgba(1,3,10,.6)}
    .modal.show{opacity:1;pointer-events:auto}
    /* toast */
    #toast{position:fixed;right:18px;bottom:18px;padding:10px 12px;background:#0b0b0b;border-radius:8px;border:1px solid rgba(255,255,255,.04);color:#cfe6ff;display:none;z-index:9999}
    /* responsive */
    @media (max-width:900px){
      #callBody{flex-direction:column}
      #rightCol{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Group Call</h1>
        <div class="sub">Dynamic build â€” chat & kick polished (controls untouched)</div>
      </div>
      <div class="small">
        <span id="statusText">Idle</span>
      </div>
    </header>


    <!-- LOGIN -->
    <div id="loginPanel" aria-live="polite">
      <div class="row">
        <input id="nickname" type="text" placeholder="Enter nickname" value="User" />
        <input id="joinCode" type="text" placeholder="Room Code (or leave blank to host)" />
        <button id="hostBtn">Host Room</button>
        <button id="joinBtn" class="ghost">Join Room</button>
        <button id="demoBtn" class="ghost">Demo (Local)</button>
      </div>
      <small class="note">Room codes are 20 characters (mixed case). Host shares the code with others. (P2P mesh â€” good for small groups.)</small>
    </div>


    <!-- CALL AREA -->
    <div id="callPanel" style="display:none;margin-top:12px;">
      <div id="callBody">
        <div id="leftCol">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>Room Code:</strong> <span id="roomDisplay"></span> <button id="copyRoom" class="ghost">Copy</button></div>
            <div class="small">Participants: <span id="participantCount">0</span></div>
          </div>


          <div id="videos" aria-live="polite" style="margin-top:10px"></div>


          <div id="toolbar">
            <button id="btnToggleCam" class="tool">Toggle Camera (C)</button>
            <button id="btnToggleMic" class="tool">Toggle Mic (M)</button>
            <button id="btnStartScreen" class="tool">Start Screen Share (S)</button>
            <button id="btnStopScreen" class="tool" style="display:none">Stop Screen Share</button>
            <button id="btnHangup" class="tool danger">Hang Up</button>
            <button id="btnToggleChat" class="tool ghost">Toggle Chat <span id="unreadBadge" style="margin-left:8px;display:none" class="badge">0</span></button>
          </div>
        </div>


        <div id="rightCol">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>Participants</strong>
              <small id="hostLabel" class="small"></small>
            </div>
            <div class="participants" id="participantsList" style="max-height:180px;overflow:auto"></div>
            <small class="small">Host can kick participants. Kick sends a disconnect message.</small>
          </div>


          <div class="panel">
            <strong>Chat</strong>
            <div id="chatBox">
              <div id="messages"></div>
              <form id="chatForm" class="chatForm" onsubmit="return false;">
                <input id="chatInput" autocomplete="off" placeholder="Say something..." />
                <button id="sendChat" class="ghost">Send</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div id="toast">Saved</div>
  </div>


  <!-- Kick confirmation modal -->
  <div id="modalKick" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3 style="margin:0 0 10px 0">Kick participant</h3>
      <p id="modalKickText" style="color:var(--muted)">Are you sure?</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalConfirm" class="danger">Kick</button>
      </div>
    </div>
  </div>


  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>


  <script>
  /************************************************************************
   * Organized + dynamic single file
   * - PRESERVES your controls' behavior (camera/mic/screen/hangup unchanged)
   * - Upgrades chat (unread badge, timestamps, enter-to-send)
   * - Upgrades kick (confirm modal, immediate UI feedback)
   * - Organized into obvious sections (STATE / UI / PEER / HELPERS)
   ************************************************************************/


  /* ============================
     STATE
     ============================ */
  const STATE = {
    peer: null,
    peerId: "",
    localStream: null,
    screenStream: null,
    peers: {},        // call objects
    dataConns: {},    // DataConnections
    connectedPeers: new Set(),
    roomCode: "",
    nickname: "",
    isHost: false,
    kicked: false,
    unread: 0
  };


  /* ============================
     DOM SHORTCUTS
     ============================ */
  const $ = id => document.getElementById(id);
  const loginPanel = $('loginPanel');
  const callPanel  = $('callPanel');
  const videos     = $('videos');
  const participantsList = $('participantsList');
  const participantCount  = $('participantCount');
  const roomDisplay = $('roomDisplay');
  const statusText  = $('statusText');
  const toastEl     = $('toast');
  const messagesEl  = $('messages');
  const chatInput   = $('chatInput');
  const unreadBadge = $('unreadBadge');
  const modalKick   = $('modalKick');
  const modalKickText = $('modalKickText');
  const modalConfirm = $('modalConfirm');
  const modalCancel = $('modalCancel');


  /* ============================
     UI BINDINGS (controls kept unchanged)
     ============================ */
  $('hostBtn').onclick = startAsHost;
  $('joinBtn').onclick = joinAsGuest;
  $('demoBtn').onclick = demoLocal;
  $('copyRoom').onclick = copyRoomCode;
  $('btnToggleCam').onclick = toggleCam;
  $('btnToggleMic').onclick = toggleMic;
  $('btnStartScreen').onclick = startScreenShare;
  $('btnStopScreen').onclick = stopScreenShare;
  $('btnHangup').onclick = () => endCall("Call ended.");
  $('btnToggleChat').onclick = () => toggleChatPanel();
  $('sendChat').onclick = sendChat;
  $('chatForm').onsubmit = e => { e.preventDefault(); sendChat(); };


  // keyboard shortcuts (C M S) preserved from your code
  window.addEventListener('keydown', (e) => {
    if (!STATE.peer) return;
    if (e.key.toLowerCase() === 'c') toggleCam();
    if (e.key.toLowerCase() === 'm') toggleMic();
    if (e.key.toLowerCase() === 's') {
      if (!STATE.screenStream) startScreenShare();
      else stopScreenShare();
    }
  });


  /* ============================
     HELPERS
     ============================ */
  function setStatus(s){ statusText.innerText = s; }
  function showToast(text, t = 1500){
    toastEl.innerText = text;
    toastEl.style.display = 'block';
    setTimeout(()=> toastEl.style.display = 'none', t);
  }
  function genRoomCode(len = 20){
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let r = "";
    for (let i=0;i<len;i++) r += chars.charAt(Math.floor(Math.random()*chars.length));
    return r;
  }
  function sanitizeId(name){
    return name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-]/g,'').slice(0,20) || 'user';
  }
  function nowTS(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }


  /* ============================
     JOIN / HOST FLOW
     ============================ */
  async function startAsHost(){
    STATE.nickname = $('nickname').value.trim() || 'Host';
    if (!STATE.nickname) return alert("Enter a nickname");
    STATE.isHost = true;
    STATE.roomCode = genRoomCode(20);
    await startPeerForRoom();
  }


  async function joinAsGuest(){
    STATE.nickname = $('nickname').value.trim() || 'Guest';
    const rc = $('joinCode').value.trim();
    if (!rc) return alert("Enter room code to join");
    STATE.roomCode = rc;
    STATE.isHost = false;
    await startPeerForRoom();
  }


  async function demoLocal(){
    STATE.nickname = 'LocalDemo';
    STATE.roomCode = genRoomCode(8);
    STATE.isHost = true;
    await startPeerForRoom(true);
  }


  async function startPeerForRoom(demo=false){
    try {
      setStatus('Starting...');
      // get local media
      STATE.localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true })
        .catch(err => { alert('Camera/mic access error: ' + err.message); throw err; });


      STATE.peerId = `${STATE.roomCode}-${STATE.isHost ? 'host' : sanitizeId(STATE.nickname)}`;
      STATE.peer = new Peer(STATE.peerId);


      STATE.peer.on('open', () => {
        setStatus('Connected to signaling');
        afterPeerOpen(demo);
      });
      STATE.peer.on('error', (err) => {
        console.error('Peer error', err);
        setStatus('Peer error');
        alert('PeerJS error: ' + (err.message || err));
      });
      STATE.peer.on('disconnected', ()=> setStatus('Disconnected (reconnecting...)'));
      STATE.peer.on('close', ()=> setStatus('Signaling closed'));
    } catch(e){ console.error(e); }
  }


  function afterPeerOpen(demo){
    // UI
    loginPanel.style.display = 'none';
    callPanel.style.display = 'block';
    roomDisplay.innerText = STATE.roomCode;
    $('hostLabel').innerText = STATE.isHost ? 'You are host' : '';
    updateParticipantCount();


    // Host listeners for incoming connections/calls
    if (STATE.isHost){
      STATE.peer.on('call', (call) => {
        call.answer(STATE.localStream);
        attachCallHandlers(call);
      });
      STATE.peer.on('connection', (conn) => setupDataConnection(conn));
      // show our own preview
      addVideo(STATE.peerId, STATE.localStream, true, STATE.nickname, true);
      updateParticipantsList();
    } else {
      // guest connects to host
      addVideo(STATE.peerId, STATE.localStream, true, STATE.nickname, true);


      const hostId = `${STATE.roomCode}-host`;
      const conn = STATE.peer.connect(hostId);
      conn.on('open', () => {
        setupDataConnection(conn);
        safeSend(conn, { type: 'introduce', peerId: STATE.peerId, nickname: STATE.nickname });
      });
      conn.on('error', e => console.warn('conn error', e));


      // call host
      const call = STATE.peer.call(hostId, STATE.localStream);
      attachCallHandlers(call);
    }


    setStatus('In call');
    showToast('Joined room');
  }


  /* ============================
     DATA CONNECTIONS
     ============================ */
  function setupDataConnection(conn){
    const id = conn.peer;
    STATE.dataConns[id] = conn;
    STATE.connectedPeers.add(id);
    conn.on('data', (msg) => handleDataMessage(id, msg));
    conn.on('close', () => {
      delete STATE.dataConns[id];
      STATE.connectedPeers.delete(id);
      removeVideo(id);
      updateParticipantsList();
      updateParticipantCount();
    });
    conn.on('error', e => console.warn('DataConn err', e));
    // ensure host (if we are host) responds to new client by sending welcome
    if (STATE.isHost && conn.open){
      safeSend(conn, { type:'welcome', peers: Array.from(STATE.connectedPeers), hostId: `${STATE.roomCode}-host` });
      updateParticipantsList();
    }
  }
  function safeSend(conn, data){
    try { if (conn && conn.open) conn.send(data); } catch(e){ console.warn('send failed', e); }
  }


  /* ============================
     CALL HANDLERS
     ============================ */
  function attachCallHandlers(call){
    const pid = call.peer;
    STATE.peers[pid] = call;
    STATE.connectedPeers.add(pid);


    call.on('stream', (stream) => {
      addVideo(pid, stream, false, guessNicknameFromId(pid));
      updateParticipantsList();
      updateParticipantCount();
      // if host, broadcast peers list to everyone (optional)
      if (STATE.isHost) broadcast({ type:'peers-list', peers:Array.from(STATE.connectedPeers) });
    });
    call.on('close', () => {
      removeVideo(pid);
      delete STATE.peers[pid];
      STATE.connectedPeers.delete(pid);
      updateParticipantsList();
      updateParticipantCount();
    });
    call.on('error', (err) => {
      console.warn('call error', err);
      removeVideo(pid);
      delete STATE.peers[pid];
      STATE.connectedPeers.delete(pid);
      updateParticipantsList();
      updateParticipantCount();
    });
  }


  /* ============================
     DATA MESSAGE HANDLING
     ============================ */
  function handleDataMessage(fromId, msg){
    // legacy string chat
    if (typeof msg === 'string' && msg.startsWith('chat:')) {
      const payload = msg.slice(5);
      addChatMessage(payload, false);
      return;
    }
    if (!msg || typeof msg !== 'object') return;
    switch(msg.type){
      case 'introduce':
        if (STATE.isHost && msg.peerId) {
          safeSend(STATE.dataConns[msg.peerId], { type:'welcome', peers:Array.from(STATE.connectedPeers), hostId: `${STATE.roomCode}-host` });
          updateParticipantsList();
        }
        break;
      case 'welcome':
        if (!STATE.isHost && msg.peers){
          msg.peers.forEach(p => { if (p !== STATE.peerId && !STATE.connectedPeers.has(p)) connectToPeer(p); });
        }
        break;
      case 'peers-list':
        // connect to new peers announced by host
        if (!STATE.isHost && msg.peers){
          msg.peers.forEach(p => { if (p !== STATE.peerId && !STATE.connectedPeers.has(p)) connectToPeer(p); });
        }
        break;
      case 'kick':
        if (msg.target === STATE.peerId){
          STATE.kicked = true;
          endCall("You were kicked by the host.");
        }
        break;
      case 'cam-toggle':
        applyCamToggle(msg.peerId, msg.enabled);
        break;
      case 'mic-toggle':
        applyMicToggle(msg.peerId, msg.enabled);
        break;
      case 'screenshare-toggle':
        applyScreenShareUI(msg.peerId, msg.enabled);
        break;
      case 'chat':
        addChatMessage(msg.text, false);
        break;
      default:
        console.log('unknown msg', msg);
    }
  }


  function connectToPeer(peerId){
    if (peerId === STATE.peerId) return;
    if (STATE.dataConns[peerId]) return;
    try {
      const conn = STATE.peer.connect(peerId);
      conn.on('open', () => {
        setupDataConnection(conn);
        const call = STATE.peer.call(peerId, STATE.screenStream || STATE.localStream);
        attachCallHandlers(call);
      });
      conn.on('error', e => console.warn('peer connect err', e));
    } catch(e){ console.warn('connectToPeer err', e); }
  }


  function broadcast(obj){
    for (let id in STATE.dataConns){
      if (STATE.dataConns[id] && STATE.dataConns[id].open) safeSend(STATE.dataConns[id], obj);
    }
  }


  /* ============================
     VIDEO / UI helpers
     ============================ */
  function addVideo(id, stream, muted=false, label=null, isMe=false){
    if (document.getElementById(`card-${id}`)) return;


    const card = document.createElement('div');
    card.className = 'vidCard';
    card.id = `card-${id}`;


    const video = document.createElement('video');
    video.id = `vid-${id}`;
    video.autoplay = true;
    video.playsInline = true;
    video.muted = muted;
    video.srcObject = stream;
    card.appendChild(video);


    const lbl = document.createElement('div');
    lbl.className = 'label';
    const nameText = label || guessNicknameFromId(id);
    lbl.innerHTML = `<span>${nameText}${isMe? ' (you)':''}</span>`;


    const micSpan = document.createElement('span');
    micSpan.id = `mic-${id}`;
    micSpan.style.marginLeft = '8px';
    micSpan.className = 'micIcon';
    micSpan.innerText = stream && stream.getAudioTracks && stream.getAudioTracks()[0] && !stream.getAudioTracks()[0].enabled ? 'ðŸ”‡' : '';
    lbl.appendChild(micSpan);


    if (id.endsWith('-host')){
      const hostBadge = document.createElement('span');
      hostBadge.className = 'hostBadge';
      hostBadge.style.marginLeft = '8px';
      hostBadge.innerText = 'HOST';
      lbl.appendChild(hostBadge);
    }


    card.appendChild(lbl);


    // camera-off overlay if needed
    try {
      const vt = stream && stream.getVideoTracks && stream.getVideoTracks()[0];
      if (!vt || (vt && vt.enabled === false)){
        const off = document.createElement('div');
        off.className = 'cameraOffOverlay';
        off.id = `camoff-${id}`;
        off.innerText = 'Camera Off';
        card.appendChild(off);
      }
      if (vt){
        vt.onmute = () => addCamOffOverlay(id);
        vt.onunmute = () => removeCamOffOverlay(id);
        vt.onended = () => addCamOffOverlay(id);
      }
      const at = stream && stream.getAudioTracks && stream.getAudioTracks()[0];
      if (at){
        at.onmute = () => updateMicIcon(id,false);
        at.onunmute = () => updateMicIcon(id,true);
      }
    } catch(e){ /* ignore non critical */ }


    videos.appendChild(card);
    adjustGrid();
    updateParticipantCount();
  }


  function removeVideo(peerId){
    const el = document.getElementById(`card-${peerId}`);
    if (el) el.remove();
    adjustGrid();
    updateParticipantCount();
  }


  function addCamOffOverlay(id){
    const card = document.getElementById(`card-${id}`);
    if (!card) return;
    if (!document.getElementById(`camoff-${id}`)){
      const off = document.createElement('div');
      off.className = 'cameraOffOverlay';
      off.id = `camoff-${id}`;
      off.innerText = 'Camera Off';
      card.appendChild(off);
    }
  }
  function removeCamOffOverlay(id){
    const el = document.getElementById(`camoff-${id}`);
    if (el) el.remove();
  }


  function updateMicIcon(id, enabled){
    const mic = document.getElementById(`mic-${id}`);
    if (!mic) return;
    mic.innerText = enabled ? '' : 'ðŸ”‡';
  }


  function applyCamToggle(peerId, enabled){ if (!enabled) addCamOffOverlay(peerId); else removeCamOffOverlay(peerId); }
  function applyMicToggle(peerId, enabled){ updateMicIcon(peerId, enabled); }
  function applyScreenShareUI(peerId, enabled){
    const c = document.getElementById(`card-${peerId}`);
    if (!c) return;
    c.style.boxShadow = enabled ? '0 0 0 3px rgba(20,200,120,0.08)' : '';
  }


  function guessNicknameFromId(id){
    const parts = id.split('-');
    if (parts.length <= 1) return id;
    return parts.slice(1).join('-');
  }


  function adjustGrid(){ const n = videos.children.length; if (n <= 1) videos.style.gridTemplateColumns = '1fr'; else if (n === 2) videos.style.gridTemplateColumns = 'repeat(2,1fr)'; else if (n === 3) videos.style.gridTemplateColumns = 'repeat(3,1fr)'; else videos.style.gridTemplateColumns = 'repeat(auto-fit,minmax(220px,1fr))'; }


  /* ============================
     CONTROLS (kept behavior same)
     ============================ */
  function toggleCam(){
    if (!STATE.localStream) return;
    const videoTrack = (STATE.screenStream ? STATE.screenStream : STATE.localStream).getVideoTracks()[0];
    if (!videoTrack) return alert('No video track available');
    const newState = !videoTrack.enabled;
    videoTrack.enabled = newState;
    applyCamToggle(STATE.peerId, newState);
    broadcast({ type:'cam-toggle', peerId: STATE.peerId, enabled: newState });
    showToast(newState ? 'Camera on' : 'Camera off');
  }


  function toggleMic(){
    if (!STATE.localStream) return;
    const audioTrack = STATE.localStream.getAudioTracks()[0];
    if (!audioTrack) return alert('No audio track available');
    audioTrack.enabled = !audioTrack.enabled;
    updateMicIcon(STATE.peerId, audioTrack.enabled);
    broadcast({ type:'mic-toggle', peerId: STATE.peerId, enabled: audioTrack.enabled });
    showToast(audioTrack.enabled ? 'Microphone on' : 'Microphone muted');
  }


  async function startScreenShare(){
    if (STATE.screenStream) return;
    try {
      STATE.screenStream = await navigator.mediaDevices.getDisplayMedia({ video:true });
      const sTrack = STATE.screenStream.getVideoTracks()[0];
      for (const id in STATE.peers){
        try {
          const senders = STATE.peers[id].peerConnection.getSenders();
          const sender = senders.find(s => s.track && s.track.kind === 'video');
          if (sender) await sender.replaceTrack(sTrack);
        } catch(e){ console.warn('replaceTrack failed', e); }
      }
      const localVideo = document.getElementById(`vid-${STATE.peerId}`);
      if (localVideo) localVideo.srcObject = STATE.screenStream;
      $('btnStartScreen').style.display = 'none';
      $('btnStopScreen').style.display = 'inline-block';
      broadcast({ type:'screenshare-toggle', peerId: STATE.peerId, enabled: true });
      sTrack.onended = () => stopScreenShare();
    } catch(err){ alert('Failed to start screen share: ' + (err.message || err)); }
  }


  async function stopScreenShare(){
    if (!STATE.screenStream) return;
    const videoTrack = STATE.localStream.getVideoTracks()[0];
    for (const id in STATE.peers){
      try {
        const senders = STATE.peers[id].peerConnection.getSenders();
        const sender = senders.find(s => s.track && s.track.kind === 'video');
        if (sender) await sender.replaceTrack(videoTrack);
      } catch(e){ console.warn('restore track failed', e); }
    }
    const localVideo = document.getElementById(`vid-${STATE.peerId}`);
    if (localVideo) localVideo.srcObject = STATE.localStream;
    STATE.screenStream.getTracks().forEach(t => t.stop());
    STATE.screenStream = null;
    $('btnStartScreen').style.display = 'inline-block';
    $('btnStopScreen').style.display = 'none';
    broadcast({ type:'screenshare-toggle', peerId: STATE.peerId, enabled: false });
  }


  /* ============================
     PARTICIPANTS / KICK
     ============================ */
  function updateParticipantsList(){
    participantsList.innerHTML = '';
    const ids = Array.from(STATE.connectedPeers);
    if (!ids.includes(STATE.peerId)) ids.unshift(STATE.peerId);


    ids.forEach(id => {
      const row = document.createElement('div');
      row.className = 'participantRow';
      const name = document.createElement('div');
      name.innerText = guessNicknameFromId(id) + (id === STATE.peerId ? ' (you)' : '');
      const right = document.createElement('div');
      const mic = document.createElement('span');
      mic.className = 'small';
      mic.style.marginRight = '8px';
      mic.innerText = '';
      right.appendChild(mic);


      if (STATE.isHost && id !== STATE.peerId){
        const kickBtn = document.createElement('button');
        kickBtn.innerText = 'Kick';
        kickBtn.onclick = () => openKickModal(id);
        kickBtn.className = 'danger';
        right.appendChild(kickBtn);
      }
      row.appendChild(name);
      row.appendChild(right);
      participantsList.appendChild(row);
    });
  }


  function openKickModal(targetId){
    modalKick.style.display = 'flex';
    setTimeout(()=> modalKick.classList.add('show'), 10);
    modalKickText.innerText = `Kick ${guessNicknameFromId(targetId)}? This will disconnect them from the room.`;
    modalConfirm.onclick = () => { doKick(targetId); closeKickModal(); };
    modalCancel.onclick = closeKickModal;
  }
  function closeKickModal(){ modalKick.classList.remove('show'); setTimeout(()=> modalKick.style.display='none', 160); }


  function doKick(targetId){
    if (!confirm) { /* noop */ }
    const conn = STATE.dataConns[targetId];
    if (conn && conn.open){
      safeSend(conn, { type:'kick', target: targetId });
      conn.close();
      removeVideo(targetId);
      STATE.connectedPeers.delete(targetId);
      delete STATE.dataConns[targetId];
      updateParticipantsList();
      updateParticipantCount();
      showToast('Kicked ' + guessNicknameFromId(targetId));
    } else {
      alert('User not connected');
    }
  }


  function updateParticipantCount(){
    const count = videos.children.length;
    participantCount.innerText = count;
  }


  /* ============================
     CHAT (dynamic)
     ============================ */
  function addChatMessage(text, isLocal){
    const div = document.createElement('div');
    div.className = 'msg ' + (isLocal ? 'me' : 'other');
    const time = nowTS();
    div.innerHTML = `<span>${escapeHtml(text)}</span> <span class="time">${time}</span>`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    if (!isLocal){
      STATE.unread++;
      updateUnreadBadge();
      ding();
      showToast('New message', 900);
    }
  }


  function sendChat(){
    const msg = chatInput.value.trim();
    if (!msg) return;
    const payload = `${STATE.nickname || 'You'}: ${msg}`;
    addChatMessage(payload, true);
    for (let id in STATE.dataConns){
      if (STATE.dataConns[id] && STATE.dataConns[id].open){
        safeSend(STATE.dataConns[id], { type:'chat', text: payload });
      }
    }
    chatInput.value = '';
  }


  function toggleChatPanel(){
    const box = $('chatBox');
    const btnBadge = unreadBadge;
    const style = window.getComputedStyle(box);
    if (style.display === 'none' || box.style.display === 'none'){
      box.style.display = 'flex';
      STATE.unread = 0; updateUnreadBadge();
    } else {
      box.style.display = 'none';
    }
  }


  function updateUnreadBadge(){
    if (!STATE.unread){
      unreadBadge.style.display = 'none';
    } else {
      unreadBadge.style.display = 'inline-block';
      unreadBadge.innerText = STATE.unread;
    }
  }


  function ding(){
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      o.frequency.value = 1200;
      o.type = 'sine';
      o.connect(audioCtx.destination);
      o.start();
      setTimeout(()=> o.stop(), 80);
    } catch(e){}
  }


  /* ============================
     CLEANUP / HANGUP
     ============================ */
  function endCall(msg){
    try { if (STATE.localStream) STATE.localStream.getTracks().forEach(t=>t.stop()); } catch(e){}
    try { if (STATE.screenStream) STATE.screenStream.getTracks().forEach(t=>t.stop()); } catch(e){}
    for (let id in STATE.peers) try { STATE.peers[id].close(); } catch(e){}
    for (let id in STATE.dataConns) try { STATE.dataConns[id].close(); } catch(e){}
    STATE.peers = {}; STATE.dataConns = {}; STATE.connectedPeers.clear();
    try { if (STATE.peer) STATE.peer.destroy(); } catch(e){}
    videos.innerHTML = ''; participantsList.innerHTML = ''; messagesEl.innerHTML = '';
    loginPanel.style.display = 'block'; callPanel.style.display = 'none';
    STATE.peer = null;
    setStatus('Idle');
    if (msg) alert(msg);
  }


  /* ============================
     UTILS
     ============================ */
  function guessNicknameFromId(id){
    const parts = id.split('-');
    if (parts.length <= 1) return id;
    return parts.slice(1).join('-');
  }


  function escapeHtml(unsafe){
    return unsafe.replace(/[&<"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m]); });
  }


  function copyRoomCode(){
    navigator.clipboard.writeText(STATE.roomCode || '').then(()=> showToast('Room code copied')).catch(()=> showToast('Copy failed'));
  }


  // beforeunload cleanup
  window.addEventListener('beforeunload', () => { try { endCall(); } catch(e){} });


  /* ============================
     Expose debug helpers
     ============================ */
  window.__gc = {
    state: () => STATE,
    end: endCall
  };


  /* ============================
     End of script
     ============================ */
  </script>
</body>
</html>
